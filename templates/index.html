{% extends "base.html" %}

{% block content %}
{% if error %}
<div style="background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-left: 4px solid #dc3545; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem;">
    {{ error }}
</div>
{% endif %}

{% if sessions %}
<div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:1.5rem; background:#f0f4f8; border:1px solid #c8d8e8; border-radius:6px; padding:0.75rem 1rem;">
    <select id="sessionSelect" style="margin:0; flex:1;">
        {% for s in sessions %}
        <option value="{{ s.id }}">{{ s.label }} &mdash; {{ s.saved_at }}</option>
        {% endfor %}
    </select>
    <button type="button" class="outline" onclick="loadSession()"
            style="white-space:nowrap; width:auto; margin:0;">Carica</button>
</div>
{% endif %}

<form method="post" action="/schedule" id="mainForm">
    <div class="grid">
        <label>
            Nome evento
            <input type="text" name="event_name" placeholder="es. Festa del rugby">
        </label>
        <label>
            Data
            <input type="date" name="event_date">
        </label>
    </div>

    {% for cat in category_order %}
    {% set config = categories[cat] %}
    <details>
        <summary>
            <label>
                <input type="checkbox" name="{{ cat }}_enabled" value="1" class="category-checkbox" data-details-id="{{ cat }}_details">
                {{ cat }}
            </label>
        </summary>
        <label>
            <input type="checkbox" name="{{ cat }}_full_day" value="1" class="full-day-checkbox" data-category="{{ cat }}">
            Giornata intera
        </label>
        <div id="{{ cat }}_lunch_options" style="display:none; background: #f0f4f8; border: 1px solid #c8d8e8; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1.5rem;">
            <div class="grid">
                <label>
                    Pausa di met√† giornata (min)
                    <input type="number" name="{{ cat }}_lunch_break" min="0"
                           placeholder="es. 60" id="{{ cat }}_lunch_break">
                </label>
                <label>
                    Distribuzione turni
                    <select name="{{ cat }}_split_ratio" id="{{ cat }}_split_ratio">
                        <option value="half">1/2 mattina, 1/2 pomeriggio</option>
                        <option value="two_thirds">2/3 mattina, 1/3 pomeriggio</option>
                    </select>
                </label>
            </div>
        </div>
        <label>
            <input type="checkbox" name="{{ cat }}_no_referee" value="1">
            Non gestire gli arbitraggi
        </label>
        <div class="grid">
            <label>
                Numero di squadre
                <select name="{{ cat }}_num_teams" class="team-count-select calc-trigger" data-category="{{ cat }}">
                    {% for n in range(3, 11) %}
                    <option value="{{ n }}" {% if n == 6 %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Numero di campi
                <select name="{{ cat }}_num_fields">
                    {% for n in range(1, 5) %}
                    <option value="{{ n }}" {% if n == 2 %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Orario di inizio
                <input type="time" name="{{ cat }}_start_time" value="09:00">
            </label>
        </div>

        <div style="background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
            <small style="color: #0c5460;">
                {% if cat == "U6" %}
                Nel calcolo dei tempi evento considerare: <strong>50% parco sportivo</strong> e <strong>50% gioco rugby</strong>
                {% else %}
                Tempo consigliato per partita: <strong>{{ recommended_match_times[cat] }} min</strong>
                {% endif %}
            </small>
        </div>

        <div class="grid">
            <label>
                Tempo totale di gioco (min)
                <input type="number" name="{{ cat }}_total_game_time" min="1"
                       value="{{ total_game_times[cat]['half'] }}"
                       class="calc-trigger" data-category="{{ cat }}"
                       id="{{ cat }}_total_game_time">
            </label>
            <label>
                Durata partita (min)
                <input type="number" name="{{ cat }}_match_duration" min="1"
                       value="{{ config.match_duration }}"
                       class="duration-input" data-category="{{ cat }}"
                       id="{{ cat }}_match_duration">
            </label>
            {% if cat == "U12" %}
            <label>
                Intervallo (min)
                <input type="number" name="{{ cat }}_half_time_interval" min="0"
                       value="0" placeholder="0 = disabilitato"
                       id="{{ cat }}_half_time_interval">
            </label>
            {% endif %}
            <label>
                Durata pausa tra partite (min)
                <input type="number" name="{{ cat }}_break_duration" min="1"
                       value="{{ config.break_duration }}"
                       class="duration-input" data-category="{{ cat }}"
                       id="{{ cat }}_break_duration">
            </label>
        </div>

        <div id="{{ cat }}_time_alert" style="display:none; background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-left: 4px solid #dc3545; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-weight: bold;">
        </div>

        <fieldset id="{{ cat }}_team_names">
            <legend>Nomi squadre (opzionale)</legend>
            <div id="{{ cat }}_names_grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                {% for i in range(1, 11) %}
                <input type="text" name="{{ cat }}_team_{{ i }}" placeholder="Squadra {{ i }}"
                       class="{{ cat }}-team-input" {% if i > 6 %}style="display:none"{% endif %}>
                {% endfor %}
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.875em; color: #666;">
                üìã Copia da:
                {% for other in category_order %}{% if other != cat %}
                <button type="button" class="outline" style="padding: 0.15rem 0.5rem; font-size: 0.8em; margin-left: 0.25rem;"
                        onclick="copyTeamNames('{{ other }}', '{{ cat }}')">{{ other }}</button>
                {% endif %}{% endfor %}
                <button type="button" class="outline" style="padding: 0.15rem 0.5rem; font-size: 0.8em; margin-left: 0.8rem;"
                        onclick="shuffleTeamNames('{{ cat }}')">üîÄ Mischia</button>
                <button type="button" class="outline" style="padding: 0.15rem 0.5rem; font-size: 0.8em; margin-left: 0.8rem;"
                        onclick="clearTeamNames('{{ cat }}')">üóëÔ∏è Cancella</button>
            </div>
        </fieldset>
    </details>
    {% endfor %}

    <div id="nameValidationError" style="display:none; background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-left: 4px solid #dc3545; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem;"></div>
    <button type="submit" id="submitBtn" disabled>Genera Calendari</button>
</form>
{% endblock %}

{% block scripts %}
<script>
const TOTAL_GAME_TIMES = {{ total_game_times | tojson }};
const RECOMMENDED_MATCH_TIMES = {{ recommended_match_times | tojson }};
const CATEGORIES = {{ category_order | tojson }};
const SESSIONS = {{ sessions | tojson }};

function loadSession() {
    const select = document.getElementById('sessionSelect');
    if (!select) return;
    if (!confirm('Caricare questa sessione? I dati del modulo verranno sovrascritti.')) return;
    const session = SESSIONS.find(s => s.id === select.value);
    if (!session) return;
    const formData = session.form_data;

    // Fill all form fields
    Object.entries(formData).forEach(([name, value]) => {
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) return;
        if (el.type === 'checkbox') {
            el.checked = value === '1';
        } else {
            el.value = value;
        }
    });

    // Sync accordion open state with checkbox state
    document.querySelectorAll('.category-checkbox').forEach(cb => {
        cb.closest('details').open = cb.checked;
    });

    // Sync full-day lunch options visibility
    document.querySelectorAll('.full-day-checkbox').forEach(cb => {
        const cat = cb.dataset.category;
        document.getElementById(`${cat}_lunch_options`).style.display = cb.checked ? '' : 'none';
        if (!cb.checked) {
            document.getElementById(`${cat}_lunch_break`).value = '';
        }
    });

    // Sync team name visibility
    document.querySelectorAll('.team-count-select').forEach(sel => {
        const cat = sel.dataset.category;
        const count = parseInt(sel.value);
        document.querySelectorAll('.' + cat + '-team-input').forEach((input, idx) => {
            input.style.display = idx < count ? '' : 'none';
        });
    });

    CATEGORIES.forEach(cat => recalculate(cat));
    updateSubmitButton();
}

// Auto-calculate match and break durations based on total game time
function recalculate(cat) {
    const numTeams = parseInt(document.querySelector(`[name="${cat}_num_teams"]`).value);
    const totalGameTime = parseInt(document.getElementById(`${cat}_total_game_time`).value);

    const matchesPerTeam = numTeams - 1;
    const matchDuration = Math.min(RECOMMENDED_MATCH_TIMES[cat], Math.floor(totalGameTime / matchesPerTeam));
    const breakDuration = Math.max(5, Math.floor(matchDuration / 2));

    document.getElementById(`${cat}_match_duration`).value = matchDuration;
    document.getElementById(`${cat}_break_duration`).value = breakDuration;

    checkOverrun(cat);
}

// Check if per-team total play time exceeds the budget
function checkOverrun(cat) {
    const numTeams = parseInt(document.querySelector(`[name="${cat}_num_teams"]`).value);
    const totalGameTime = parseInt(document.getElementById(`${cat}_total_game_time`).value);
    const matchDuration = parseInt(document.getElementById(`${cat}_match_duration`).value);

    const matchesPerTeam = numTeams - 1;
    const actualTotal = matchesPerTeam * matchDuration;

    const alertDiv = document.getElementById(`${cat}_time_alert`);
    if (actualTotal > totalGameTime) {
        alertDiv.textContent = `Attenzione: il tempo totale di gioco per squadra (${actualTotal} min) supera il limite (${totalGameTime} min)`;
        alertDiv.style.display = '';
    } else {
        alertDiv.style.display = 'none';
    }
}

// Per-category full day toggle
document.querySelectorAll('.full-day-checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
        const cat = this.dataset.category;
        const dayKey = this.checked ? 'full' : 'half';
        document.getElementById(`${cat}_total_game_time`).value = TOTAL_GAME_TIMES[cat][dayKey];
        recalculate(cat);
        // Show/hide lunch break options
        document.getElementById(`${cat}_lunch_options`).style.display = this.checked ? '' : 'none';
        if (!this.checked) {
            document.getElementById(`${cat}_lunch_break`).value = '';
        }
    });
});

// Recalculate on changes to teams, fields, dedicated refs, or total game time
document.querySelectorAll('.calc-trigger').forEach(el => {
    el.addEventListener('change', function() {
        recalculate(this.dataset.category);
    });
});

// Check overrun on manual duration changes
document.querySelectorAll('.duration-input').forEach(el => {
    el.addEventListener('change', function() {
        checkOverrun(this.dataset.category);
    });
});

// Team name visibility
document.querySelectorAll('.team-count-select').forEach(select => {
    select.addEventListener('change', function() {
        const cat = this.dataset.category;
        const count = parseInt(this.value);
        document.querySelectorAll('.' + cat + '-team-input').forEach((input, idx) => {
            input.style.display = idx < count ? '' : 'none';
        });
    });
});

// Initial calculation for all categories
CATEGORIES.forEach(cat => recalculate(cat));

// Clear all team name inputs for a category
function clearTeamNames(cat) {
    if (!confirm(`Cancellare tutti i nomi squadra per ${cat}?`)) return;
    document.querySelectorAll(`.${cat}-team-input`).forEach(input => {
        input.value = '';
    });
}

// Shuffle filled team names for a category (empty fields stay empty)
function shuffleTeamNames(cat) {
    if (!confirm(`Mischiare i nomi squadra per ${cat}?`)) return;
    const inputs = [...document.querySelectorAll(`.${cat}-team-input`)].filter(i => i.style.display !== 'none');
    const filled = inputs.filter(i => i.value.trim() !== '');
    const values = filled.map(i => i.value.trim());
    for (let i = values.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [values[i], values[j]] = [values[j], values[i]];
    }
    filled.forEach((input, idx) => { input.value = values[idx]; });
}

// Copy team names from one category to another
function copyTeamNames(src, dst) {
    const srcCount = parseInt(document.querySelector(`[name="${src}_num_teams"]`).value);
    const dstCount = parseInt(document.querySelector(`[name="${dst}_num_teams"]`).value);
    const count = Math.min(srcCount, dstCount);
    for (let i = 1; i <= count; i++) {
        const val = document.querySelector(`[name="${src}_team_${i}"]`).value;
        document.querySelector(`[name="${dst}_team_${i}"]`).value = val;
    }
}

// Accordion: open/close <details> when category checkbox changes
// Submit button: enabled only when at least one category is checked
const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
const submitBtn = document.getElementById('submitBtn');

function updateSubmitButton() {
    submitBtn.disabled = !Array.from(categoryCheckboxes).some(cb => cb.checked);
}

categoryCheckboxes.forEach(cb => {
    cb.addEventListener('change', function() {
        this.closest('details').open = this.checked;
        updateSubmitButton();
    });
});

updateSubmitButton();

// Validate duplicate team names for active categories
function validateTeamNames() {
    const errors = [];
    CATEGORIES.forEach(cat => {
        const checkbox = document.querySelector(`[name="${cat}_enabled"]`);
        if (!checkbox || !checkbox.checked) return;

        const count = parseInt(document.querySelector(`[name="${cat}_num_teams"]`).value);
        const names = [];
        for (let i = 1; i <= count; i++) {
            const input = document.querySelector(`[name="${cat}_team_${i}"]`);
            const val = input ? input.value.trim() : '';
            names.push(val || `Squadra ${i}`);
        }

        const seen = new Set();
        const duplicates = new Set();
        names.forEach(name => {
            const lower = name.toLowerCase();
            if (seen.has(lower)) duplicates.add(name);
            else seen.add(lower);
        });

        if (duplicates.size > 0) {
            errors.push(`<strong>${cat}</strong>: nomi squadra duplicati: ${[...duplicates].join(', ')}`);
        }
    });
    return errors;
}

document.getElementById('mainForm').addEventListener('submit', function(e) {
    const errors = validateTeamNames();
    const errorDiv = document.getElementById('nameValidationError');
    if (errors.length > 0) {
        e.preventDefault();
        errorDiv.innerHTML = 'Correggi i seguenti errori prima di procedere:<br>' + errors.join('<br>');
        errorDiv.style.display = '';
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        errorDiv.style.display = 'none';
    }
});
</script>
{% endblock %}
