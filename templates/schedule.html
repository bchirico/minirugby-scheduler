{% extends "base.html" %}

{% block content %}
<!-- Hidden form for downloads (re-submits same data) -->
<form method="post" id="downloadForm" style="display:none">
    {% for key, value in form_data.items(True) %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
</form>

<div class="grid" style="margin-bottom: 1rem;">
    <button onclick="submitDownload('/download/pdf')">Scarica PDF</button>
    <button onclick="submitDownload('/download/excel')" class="secondary">Scarica Excel</button>
    <button onclick="history.back()" class="outline">Torna al Modulo</button>
</div>

<div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:1.5rem;">
    <input type="text" id="sessionLabel" placeholder="Nome sessione (lascia vuoto per usare nome/data evento)"
           style="margin:0; flex:1;">
    <button type="button" class="outline" onclick="saveSession()"
            style="white-space:nowrap; width:auto; margin:0;">Salva sessione</button>
    <span id="saveMsg" style="display:none; color:#0a7c42; font-weight:bold;">&#10003; Salvato!</span>
</div>

{% if event_name or event_date %}
<div style="margin-bottom: 1.5rem;">
    {% if event_name %}<h2 style="margin-bottom: 0.25rem;">{{ event_name }}</h2>{% endif %}
    {% if event_date %}<p style="color: #666; margin: 0;">{{ event_date }}</p>{% endif %}
</div>
{% endif %}

{% for schedule in schedules %}
<article>
    <header>
        <h2>{{ schedule.category }}</h2>
        <small>{{ schedule.matches | length }} partite | {{ schedule.stats | length }} squadre</small>
    </header>

    {% if schedule.time_overrun_warning %}
    <div style="background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-left: 4px solid #dc3545; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-weight: bold;">
        <p>{{ schedule.time_overrun_warning }}</p>
    </div>
    {% endif %}

    {% if schedule.warnings %}
    <div style="background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem;">
        {% for w in schedule.warnings %}
        <p><strong>Nota:</strong> {{ w }}</p>
        {% endfor %}
    </div>
    {% endif %}

    {% set ns = namespace(current_slot=-1) %}
    {% for match in schedule.matches %}
        {% if match.time_slot != ns.current_slot %}
            {% if ns.current_slot >= 0 %}
            </tbody></table>
            {% with resting = schedule.resting_per_slot.get(ns.current_slot, []) %}
            {% if resting %}
            <p style="color: #666; font-style: italic; margin: 0.25rem 0 0.75rem 0.25rem; font-size: 0.9em;">Riposa: {{ resting | join(', ') }}</p>
            {% endif %}
            {% endwith %}
            {% endif %}
            {% if schedule.morning_slots > 0 and match.time_slot == schedule.morning_slots %}
            <div style="background: #e8f0fe; border: 2px solid #4a6cf7; border-radius: 8px; padding: 0.75rem 1.25rem; margin: 1rem 0; text-align: center; font-weight: bold; font-size: 1.05em; letter-spacing: 0.05em;">
                &#9679; PAUSA &mdash; {{ schedule.lunch_break }} min
            </div>
            {% endif %}
            {% set ns.current_slot = match.time_slot %}
            <h4>Turno {{ match.time_slot + 1 }} &mdash; {{ match.start_time }}</h4>
            <table>
            <thead><tr>
                <th>Campo</th>
                <th>Partita</th>
                {% if not schedule.no_referee %}<th>Arbitro</th>{% endif %}
            </tr></thead>
            <tbody>
        {% endif %}
        <tr>
            <td>Campo {{ match.field_number }}</td>
            <td><strong>{{ match.team1 }}</strong> vs <strong>{{ match.team2 }}</strong></td>
            {% if not schedule.no_referee %}<td>{{ match.referee }}</td>{% endif %}
        </tr>
    {% endfor %}
    {% if schedule.matches %}
    </tbody></table>
    {% with resting = schedule.resting_per_slot.get(ns.current_slot, []) %}
    {% if resting %}
    <p style="color: #666; font-style: italic; margin: 0.25rem 0 0.75rem 0.25rem; font-size: 0.9em;">Riposa: {{ resting | join(', ') }}</p>
    {% endif %}
    {% endwith %}
    {% endif %}

    <h4>Statistiche</h4>
    <table>
        <thead><tr>
            <th>Squadra</th>
            <th>Partite Giocate</th>
            {% if not schedule.no_referee %}<th>Arbitraggi</th>{% endif %}
            <th>Max Attesa</th>
        </tr></thead>
        <tbody>
        {% for team, stat in schedule.stats.items() %}
        <tr>
            <td>{{ team }}</td>
            <td>{{ stat.played }}</td>
            {% if not schedule.no_referee %}<td>{{ stat.refereed }}</td>{% endif %}
            <td>{{ stat.max_wait }} min</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</article>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
function submitDownload(url) {
    const form = document.getElementById('downloadForm');
    form.action = url;
    form.submit();
}

function saveSession() {
    const label = document.getElementById('sessionLabel').value.trim();
    const formData = {};
    document.querySelectorAll('#downloadForm input[type="hidden"]').forEach(input => {
        formData[input.name] = input.value;
    });
    fetch('/save-session', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({label, form_data: formData})
    }).then(r => r.json()).then(data => {
        if (data.ok) {
            const msg = document.getElementById('saveMsg');
            msg.style.display = '';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }
    });
}
</script>
{% endblock %}
