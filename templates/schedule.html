{% extends "base.html" %}

{% block content %}
<!-- Hidden form for downloads (re-submits same data) -->
<form method="post" id="downloadForm" style="display:none">
    {% for key, value in form_data.items(True) %}
    <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
</form>

<div class="grid" style="margin-bottom: 2rem;">
    <button onclick="submitDownload('/download/pdf')">Scarica PDF</button>
    <button onclick="submitDownload('/download/excel')" class="secondary">Scarica Excel</button>
    <button onclick="history.back()" class="outline">Torna al Modulo</button>
</div>

{% for schedule in schedules %}
<article>
    <header>
        <h2>{{ schedule.category }}</h2>
        <small>{{ schedule.matches | length }} partite | {{ schedule.stats | length }} squadre</small>
    </header>

    {% if schedule.time_overrun_warning %}
    <div style="background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; border-left: 4px solid #dc3545; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; font-weight: bold;">
        <p>{{ schedule.time_overrun_warning }}</p>
    </div>
    {% endif %}

    {% if schedule.warnings %}
    <div style="background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem;">
        {% for w in schedule.warnings %}
        <p><strong>Nota:</strong> {{ w }}</p>
        {% endfor %}
    </div>
    {% endif %}

    {% set ns = namespace(current_slot=-1) %}
    {% for match in schedule.matches %}
        {% if match.time_slot != ns.current_slot %}
            {% if ns.current_slot >= 0 %}
            </tbody></table>
            {% with resting = schedule.resting_per_slot.get(ns.current_slot, []) %}
            {% if resting %}
            <p style="color: #666; font-style: italic; margin: 0.25rem 0 0.75rem 0.25rem; font-size: 0.9em;">Riposa: {{ resting | join(', ') }}</p>
            {% endif %}
            {% endwith %}
            {% endif %}
            {% set ns.current_slot = match.time_slot %}
            <h4>Turno {{ match.time_slot + 1 }} &mdash; {{ match.start_time }}</h4>
            <table>
            <thead><tr>
                <th>Campo</th>
                <th>Partita</th>
                <th>Arbitro</th>
            </tr></thead>
            <tbody>
        {% endif %}
        <tr>
            <td>Campo {{ match.field_number }}</td>
            <td><strong>{{ match.team1 }}</strong> vs <strong>{{ match.team2 }}</strong></td>
            <td>{{ match.referee }}</td>
        </tr>
    {% endfor %}
    {% if schedule.matches %}
    </tbody></table>
    {% with resting = schedule.resting_per_slot.get(ns.current_slot, []) %}
    {% if resting %}
    <p style="color: #666; font-style: italic; margin: 0.25rem 0 0.75rem 0.25rem; font-size: 0.9em;">Riposa: {{ resting | join(', ') }}</p>
    {% endif %}
    {% endwith %}
    {% endif %}

    <h4>Statistiche</h4>
    <table>
        <thead><tr>
            <th>Squadra</th>
            <th>Partite Giocate</th>
            <th>Arbitraggi</th>
            <th>Max Attesa</th>
        </tr></thead>
        <tbody>
        {% for team, stat in schedule.stats.items() %}
        <tr>
            <td>{{ team }}</td>
            <td>{{ stat.played }}</td>
            <td>{{ stat.refereed }}</td>
            <td>{{ stat.max_wait }} min</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</article>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
function submitDownload(url) {
    const form = document.getElementById('downloadForm');
    form.action = url;
    form.submit();
}
</script>
{% endblock %}
